<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - The Atlantic</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .search-results-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 80vh;
        }

        .search-query {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e74c3c;
            text-align: left;
        }

        .answer-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 200px;
        }

        .answer-text {
            font-size: 16px;
            line-height: 1.6;
            color: #34495e;
            margin: 0;
            white-space: pre-wrap;
        }


        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6c757d;
            font-style: italic;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            background-color: #e74c3c;
            border-radius: 50%;
            animation: loading-bounce 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes loading-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }


        .conversation-container {
            margin-top: 30px;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px 0;
        }

        .message.user {
            color: #2c3e50;
            font-weight: 600;
            font-size: 18px;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e74c3c;
        }

        .message.assistant {
            color: #34495e;
            font-size: 16px;
            line-height: 1.6;
        }

        .follow-up-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .follow-up-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .follow-up-input button {
            padding: 12px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .follow-up-input button:hover {
            background: #c0392b;
        }

        .follow-up-input button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
            z-index: 1000;
        }

        .back-button:hover {
            background: #c0392b;
            text-decoration: none;
            color: white;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .suggestion-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .suggestion-chip {
            background: #e9ecef;
            color: #495057;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .suggestion-chip:hover {
            background: #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="site-header">
        <div class="container">
            <nav class="main-nav">
                <div class="nav-left">
                    <ul class="nav-menu">
                        <li><a href="search-up-top.html" class="nav-item">Search up top</a></li>
                        <li><a href="new-green.html" class="nav-item">New green</a></li>
                        <li><a href="side-rail.html" class="nav-item">Side rail</a></li>
                        <li><a href="top-of-article-old.html" class="nav-item">Top of article (old)</a></li>
                        <li><a href="middle-of-article.html" class="nav-item">Middle of article</a></li>
                        <li><a href="bottom-of-article-embed.html" class="nav-item">Bottom of article embed</a></li>
                        <li><a href="dynamic-cta.html" class="nav-item">Dynamic cta</a></li>
                        <li><a href="update-askinbio.html" class="nav-item">Update askinbio</a></li>
                    </ul>
                </div>
                <div class="nav-right">
                    <a href="../index.html" class="logo-link">
                        <div class="logo">
                            <img src="../assets/images/theatlantic.png" alt="The Atlantic" class="logo-image">
                        </div>
                    </a>
                    <span class="site-name">The Atlantic</span>
                    <a href="#" class="sign-in">Sign In</a>
                    <button class="subscribe-btn">Subscribe</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Back Button -->
    <a href="javascript:history.back()" class="back-button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m12 19-7-7 7-7"/>
            <path d="M19 12H5"/>
        </svg>
        Back
    </a>

    <div class="search-results-container">
        <!-- Conversation Container -->
        <div class="conversation-container" id="conversationContainer">
            <!-- Messages will be added here -->
        </div>

        <!-- Follow-up Input -->
        <div class="follow-up-input">
            <input type="text" placeholder="Ask a follow-up question..." id="followUpInput">
            <button id="sendButton">Send</button>
        </div>

    </div>

    <script>
        // AI Chat Implementation
        class AIChat {
            constructor() {
                this.messages = [];
                this.isStreaming = false;
                this.conversationContainer = document.getElementById('conversationContainer');
                this.followUpInput = document.getElementById('followUpInput');
                this.sendButton = document.getElementById('sendButton');

                this.initializeEventListeners();
            }

            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.handleSend());
                this.followUpInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isStreaming) {
                        this.handleSend();
                    }
                });
            }

            async handleSend() {
                const message = this.followUpInput.value.trim();
                if (!message || this.isStreaming) return;

                this.followUpInput.value = '';
                this.sendButton.disabled = true;

                // Add user message
                this.addMessage(message, 'user');
                this.messages.push({ role: 'user', content: message });

                // Stream AI response
                await this.streamAIResponse();
            }

            addMessage(content, role) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                messageDiv.innerHTML = `<div class="answer-text">${content}</div>`;
                this.conversationContainer.appendChild(messageDiv);
                messageDiv.scrollIntoView({ behavior: 'smooth' });
            }

            async streamAIResponse() {
                this.isStreaming = true;

                // Create message container for streaming
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-text';

                messageDiv.appendChild(answerDiv);
                this.conversationContainer.appendChild(messageDiv);

                try {
                    // Check if we have a real AI API endpoint
                    const hasRealAPI = true; // OpenAI API is now configured

                    if (hasRealAPI) {
                        await this.streamFromAPI(answerDiv);
                    } else {
                        await this.simulateStreaming(answerDiv);
                    }
                } catch (error) {
                    console.error('Streaming error:', error);
                    answerDiv.innerHTML = '<div class="error-message">Sorry, I encountered an error. Please try again.</div>';
                } finally {
                    this.isStreaming = false;
                    this.sendButton.disabled = false;
                    messageDiv.scrollIntoView({ behavior: 'smooth' });
                }
            }

            async streamFromAPI(answerDiv) {
                // Real API streaming implementation with OpenAI
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: this.messages })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed: ${response.status} - ${errorText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });

                        // For simple text streaming (our server sends plain text)
                        answerDiv.textContent += chunk;

                        // Keep bottom in view while streaming
                        window.scrollTo({
                            top: document.documentElement.scrollHeight,
                            behavior: 'smooth'
                        });
                    }
                } catch (streamError) {
                    console.error('Streaming error:', streamError);
                    throw streamError;
                }
            }

            async simulateStreaming(answerDiv) {
                // Get enhanced response from our Context7-integrated system
                const latestMessage = this.messages[this.messages.length - 1];
                const response = await this.getEnhancedResponse(latestMessage.content);

                // Simulate streaming with typewriter effect
                let currentIndex = 0;
                const streamingSpeed = 8; // ms between characters

                return new Promise((resolve) => {
                    let scrollCounter = 0;
                    const typeInterval = setInterval(() => {
                        if (currentIndex < response.text.length) {
                            answerDiv.textContent += response.text.charAt(currentIndex);
                            currentIndex++;
                            scrollCounter++;

                            // Keep bottom in view while streaming (every 5 characters for smoother performance)
                            if (scrollCounter % 5 === 0) {
                                window.scrollTo({
                                    top: document.documentElement.scrollHeight,
                                    behavior: 'auto'
                                });
                            }
                        } else {
                            clearInterval(typeInterval);

                            // Add suggestion chips
                            if (response.suggestions) {
                                this.addSuggestionChips(answerDiv, response.suggestions);
                            }


                            resolve();
                        }
                    }, streamingSpeed);
                });
            }

            async getEnhancedResponse(query) {
                // Popular Science style responses
                const responses = {
                    'ai': {
                        text: `Researchers at leading AI laboratories have developed transformer models that demonstrate unprecedented capabilities in reasoning, creativity, and problem-solving, fundamentally revolutionizing how humans interact with artificial intelligence. Recent studies show these large language models can process and generate text with remarkable sophistication, while new multimodal systems simultaneously handle text, images, and audio data with increasing accuracy. However, scientists are now grappling with important questions about AI safety, bias, and societal impact as these systems become more powerful and widespread in everyday applications.`,
                        suggestions: ['What are the latest AI breakthroughs?', 'How does AI bias work?', 'Tell me about AI safety']
                    },
                    'chatbot': {
                        text: `Computational linguists and behavioral scientists have transformed simple rule-based chatbots into sophisticated AI-powered conversational agents that use advanced natural language processing to understand context and maintain coherent dialogue. According to recent psychological research, companies are now employing techniques from behavioral science—including variable reward schedules and social validation mechanisms—to keep users engaged, representing a fundamental shift from utility-focused tools to engagement-optimized experiences. This evolution raises critical questions about digital wellness and AI dependency, as studies suggest users may develop parasocial relationships with increasingly sophisticated chatbot systems that closely mimic human conversation patterns.`,
                        suggestions: ['How do chatbots manipulate users?', 'What are the risks of AI dependency?', 'How can I protect myself?']
                    },
                    'technology': {
                        text: `Scientists and engineers across the globe are pushing the boundaries of technological innovation at an unprecedented pace, with breakthroughs in quantum computing, biotechnology, and artificial intelligence reshaping entire industries. Research teams have developed cloud computing infrastructures that enable massive scalability and remote collaboration, while Internet of Things (IoT) devices create interconnected networks where everyday objects can communicate and share data in real-time. As our digital footprint expands exponentially, cybersecurity researchers are working to develop new protection methods and regulatory frameworks to safeguard user privacy while maintaining the momentum of technological advancement.`,
                        suggestions: ['What are emerging tech trends?', 'How does quantum computing work?', 'Tell me about tech privacy']
                    }
                };

                const lowerQuery = query.toLowerCase();

                if (lowerQuery.includes('ai') || lowerQuery.includes('artificial intelligence')) {
                    return responses.ai;
                } else if (lowerQuery.includes('chatbot') || lowerQuery.includes('chat') || lowerQuery.includes('bot')) {
                    return responses.chatbot;
                } else if (lowerQuery.includes('technology') || lowerQuery.includes('tech')) {
                    return responses.technology;
                }

                // Default response in Popular Science style
                return {
                    text: `Research teams across multiple disciplines are uncovering fascinating connections between technology, society, and human behavior that continue to shape our understanding of modern life. Scientists are employing interdisciplinary approaches to analyze both immediate effects and long-term societal trends, revealing complex patterns that require careful examination from multiple perspectives. These investigations are providing crucial insights into how technological innovation, cultural shifts, and policy decisions interact in ways that fundamentally influence human development and social structures.`,
                    suggestions: ['Can you elaborate on that?', 'What are the implications?', 'Tell me more']
                };
            }

            addSuggestionChips(container, suggestions) {
                const chipsContainer = document.createElement('div');
                chipsContainer.className = 'suggestion-chips';

                suggestions.forEach(suggestion => {
                    const chip = document.createElement('span');
                    chip.className = 'suggestion-chip';
                    chip.textContent = suggestion;
                    chip.addEventListener('click', () => {
                        this.followUpInput.value = suggestion;
                        this.handleSend();
                    });
                    chipsContainer.appendChild(chip);
                });

                container.appendChild(chipsContainer);
            }


            async initializeWithQuery(query) {
                document.title = `"${query}" - AI Search Results - The Atlantic`;

                // Add initial user message
                this.addMessage(query, 'user');
                this.messages.push({ role: 'user', content: query });

                // Start streaming response
                await this.streamAIResponse();
            }
        }

        // Initialize the chat system
        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const chat = new AIChat();
            const query = getQueryParameter('q');

            if (query) {
                chat.initializeWithQuery(query);
            } else {
                document.getElementById('conversationContainer').innerHTML =
                    '<div class="error-message">Please enter a search query to get started.</div>';
            }
        });
    </script>
</body>
</html>