<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - The Atlantic</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .search-results-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 80vh;
        }

        .search-query {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e74c3c;
            text-align: left;
        }

        .answer-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 200px;
        }

        .answer-text {
            font-size: 16px;
            line-height: 1.6;
            color: #34495e;
            margin: 0;
            white-space: pre-wrap;
        }


        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6c757d;
            font-style: italic;
        }

        .loading-stage-container {
            margin: 20px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-stage {
            display: flex;
            align-items: center;
            gap: 12px;
            transition: opacity 0.4s ease-in-out;
            opacity: 0;
        }

        .loading-stage.visible {
            opacity: 1;
        }

        .spinner-icon {
            width: 18px;
            height: 18px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #e74c3c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stage-text {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            background-color: #e74c3c;
            border-radius: 50%;
            animation: loading-bounce 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes loading-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }


        .conversation-container {
            margin-top: 30px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 0;
        }

        .message.user {
            color: #2c3e50;
            font-weight: 600;
            font-size: 18px;
            padding-bottom: 15px;
            margin-bottom: 10px;
            border-bottom: 2px solid #e74c3c;
        }

        .message.assistant {
            color: #34495e;
            font-size: 16px;
            line-height: 1.6;
        }

        .follow-up-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .follow-up-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .follow-up-input button {
            padding: 12px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .follow-up-input button:hover {
            background: #c0392b;
        }

        .follow-up-input button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
            z-index: 1000;
        }

        .back-button:hover {
            background: #c0392b;
            text-decoration: none;
            color: white;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .suggestion-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .suggestion-chip {
            background: #e9ecef;
            color: #495057;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .suggestion-chip:hover {
            background: #dee2e6;
        }

        .attribution-section {
            margin: 10px 0 15px 0;
        }

        .attribution-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .combined-attribution-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            margin-bottom: 10px;
        }

        .attribution-segment {
            height: 100%;
            transition: width 1.5s ease-in-out;
            width: 0%;
        }

        .attribution-segment.primary {
            background: #e74c3c;
        }

        .attribution-segment.secondary {
            background: #3498db;
        }

        .attribution-segment.tertiary {
            background: #95a5a6;
        }

        .attribution-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6c757d;
        }

        .attribution-label {
            font-weight: 500;
        }

        .attribution-label.primary {
            color: #e74c3c;
        }

        .attribution-label.secondary {
            color: #3498db;
        }

        .attribution-label.tertiary {
            color: #95a5a6;
        }

        .sources-section {
            margin: 15px 0 20px 0;
            position: relative;
            padding: 0 60px; /* Add padding for carousel buttons */
        }

        .sources-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .sources-carousel-container {
            position: relative;
            overflow: hidden;
            width: 100%;
            min-height: 150px;
            max-width: 648px; /* 3 cards * 216px */
            margin: 0 auto;
        }

        .sources-carousel-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 750px;
            margin: 0 auto;
        }

        .sources-carousel {
            display: flex;
            transition: transform 0.3s ease-in-out;
            gap: 16px;
            width: max-content;
        }

        .sources-grid {
            display: flex;
            gap: 16px;
            min-width: 100%;
        }

        .source-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
            flex: 0 0 200px;
            min-width: 200px;
            max-width: 220px;
        }

        .source-card.active {
            border-color: #e74c3c;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.1);
        }

        .source-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #e74c3c;
        }

        .source-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .source-favicon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background: #e74c3c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .source-domain {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .source-title {
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
            line-height: 1.2;
        }

        .source-snippet {
            font-size: 11px;
            color: #6c757d;
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .source-attribution {
            font-size: 12px;
            color: #e74c3c;
            font-weight: 500;
        }

        .sources-section {
            position: relative;
        }

        .carousel-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            position: static;
        }

        .carousel-button {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 20px;
            position: relative;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            flex-shrink: 0;
            margin: 0 10px;
        }

        .carousel-button#prevButton {
            margin-right: 15px;
        }

        .carousel-button#nextButton {
            margin-left: 15px;
        }

        .carousel-button:hover:not(:disabled) {
            background: #c0392b;
            transform: scale(1.1);
        }

        .carousel-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .carousel-indicators {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #bdc3c7;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .carousel-dot.active {
            background: #e74c3c;
        }

        .skeleton-sources {
            display: flex !important;
            flex-direction: row !important;
            gap: 16px;
            margin: 15px 0;
            overflow: hidden;
            width: 100%;
            align-items: flex-start;
            flex-wrap: nowrap;
        }

        .skeleton-source-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            animation: skeletonPulse 1.5s ease-in-out infinite alternate;
            flex: 0 0 200px;
            min-width: 200px;
            max-width: 200px;
            height: auto;
        }

        .skeleton-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .skeleton-favicon {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            background: #e9ecef;
        }

        .skeleton-domain {
            width: 60px;
            height: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .skeleton-title {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .skeleton-snippet {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .skeleton-snippet:last-of-type {
            width: 75%;
            margin-bottom: 8px;
        }

        .skeleton-attribution {
            width: 50px;
            height: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }

        @keyframes skeletonPulse {
            0% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <!-- Combined Header -->
    <header class="site-header" style="border-bottom: 1px solid #000;">
        <div class="container">
            <!-- Top Navigation Bar -->
            <div style="display: flex; justify-content: center; padding: 10px 0; border-bottom: 1px solid #e5e5e5;">
                <ul style="display: flex; list-style: none; margin: 0; padding: 0; gap: 30px;">
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Latest</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Politics</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Ideas</a></li>
                    <li><a href="#" style="color: #e74c3c; text-decoration: none; font-size: 14px; font-weight: 500;">Technology</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Science</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Culture</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Health</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Education</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Planet</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Books</a></li>
                    <li><a href="#" style="color: #333; text-decoration: none; font-size: 14px; font-weight: 500;">Family</a></li>
                </ul>
            </div>

            <!-- Second Nav Bar with Logo -->
            <nav class="main-nav" style="display: flex; align-items: center; justify-content: space-between; padding: 15px 0;">
                <div style="display: flex; align-items: center; gap: 30px;">
                    <nav>
                        <div class="nav-dropdown" id="navDropdown">
                            <button class="nav-dropdown-button" id="navDropdownButton" style="background: #333; color: white; padding: 10px 15px; font-size: 12px; font-weight: 600; border: none; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                                Widgets
                                <svg class="nav-dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M6 9L12 15L18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <div class="nav-dropdown-menu" id="navDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 200px; z-index: 1000;">
                                <a href="search-up-top.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">Search up top</a>
                                <a href="new-green.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">New green</a>
                                <a href="side-rail.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">Side rail</a>
                                <a href="top-of-article-old.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">Top of article (old)</a>
                                <a href="middle-of-article.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">Middle of article</a>
                                <a href="bottom-of-article-embed.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">Bottom of article embed</a>
                                <a href="dynamic-cta.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">Dynamic cta</a>
                                <a href="top-rail-search.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">Top rail search</a>
                                <a href="update-askinbio.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500; border-bottom: 1px solid #f0f0f0;">Update askinbio</a>
                                <a href="header-html.html" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; font-size: 12px; font-weight: 500;">Header HTML</a>
                            </div>
                        </div>
                    </nav>

                    <!-- Additional nav items inline -->
                    <a href="#" style="color: #6c757d; text-decoration: none; font-size: 13px;">Newsletters</a>
                    <a href="#" style="color: #6c757d; text-decoration: none; font-size: 13px;">Podcasts</a>
                    <a href="#" style="color: #6c757d; text-decoration: none; font-size: 13px;">The Pacific Daily</a>
                    <a href="#" style="color: #6c757d; text-decoration: none; font-size: 13px;">Magazine</a>
                </div>

                <div class="logo" style="font-size: 28px; font-weight: 900; letter-spacing: -0.5px; position: absolute; left: 50%; transform: translateX(-50%);">THE PACIFIC</div>

                <div class="nav-right" style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #6c757d; font-size: 13px;">December 2024 Issue</span>
                    <span style="color: #6c757d;">•</span>
                    <a href="#" style="color: #e74c3c; text-decoration: none; font-size: 13px; font-weight: 600;">Subscribe</a>
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 20px; height: 20px; cursor: pointer;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </div>
            </nav>
        </div>
    </header>

    <!-- Back Button -->
    <a href="javascript:history.back()" class="back-button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m12 19-7-7 7-7"/>
            <path d="M19 12H5"/>
        </svg>
        Back
    </a>

    <div class="search-results-container">
        <!-- Conversation Container -->
        <div class="conversation-container" id="conversationContainer">
            <!-- Messages will be added here -->
        </div>

        <!-- Follow-up Input -->
        <div class="follow-up-input">
            <input type="text" placeholder="Ask a follow-up question..." id="followUpInput">
            <button id="sendButton">Send</button>
        </div>

    </div>

    <!-- Attribution and Sources sections will be dynamically inserted here -->

    <script>
        // AI Chat Implementation
        class AIChat {
            constructor() {
                this.messages = [];
                this.isStreaming = false;
                this.conversationContainer = document.getElementById('conversationContainer');
                this.followUpInput = document.getElementById('followUpInput');
                this.sendButton = document.getElementById('sendButton');

                this.initializeEventListeners();
            }

            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.handleSend());
                this.followUpInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isStreaming) {
                        this.handleSend();
                    }
                });
            }

            async handleSend() {
                const message = this.followUpInput.value.trim();
                if (!message || this.isStreaming) return;

                this.followUpInput.value = '';
                this.sendButton.disabled = true;

                // Add user message
                this.addMessage(message, 'user');
                this.messages.push({ role: 'user', content: message });

                // Stream AI response
                await this.streamAIResponse();
            }

            addMessage(content, role) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                messageDiv.innerHTML = `<div class="answer-text">${content}</div>`;
                this.conversationContainer.appendChild(messageDiv);
                messageDiv.scrollIntoView({ behavior: 'smooth' });
            }

            async streamAIResponse() {
                this.isStreaming = true;

                // Create loading stages
                await this.showLoadingStages();

                // Show attribution and sources before AI response
                await this.showAttributionAndSources();

                // Create message container for streaming
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-text';

                messageDiv.appendChild(answerDiv);
                this.conversationContainer.appendChild(messageDiv);

                try {
                    // Check if we have a real AI API endpoint
                    const hasRealAPI = true; // OpenAI API is now configured

                    if (hasRealAPI) {
                        await this.streamFromAPI(answerDiv);
                    } else {
                        await this.simulateStreaming(answerDiv);
                    }

                } catch (error) {
                    console.error('Streaming error:', error);
                    answerDiv.innerHTML = '<div class="error-message">Sorry, I encountered an error. Please try again.</div>';
                } finally {
                    this.isStreaming = false;
                    this.sendButton.disabled = false;
                    messageDiv.scrollIntoView({ behavior: 'smooth' });
                }
            }

            async streamFromAPI(answerDiv) {
                // Real API streaming implementation with OpenAI
                // Use relative path to work with any server configuration
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: this.messages })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed: ${response.status} - ${errorText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });

                        // For simple text streaming (our server sends plain text)
                        answerDiv.textContent += chunk;

                        // Keep bottom in view while streaming
                        window.scrollTo({
                            top: document.documentElement.scrollHeight,
                            behavior: 'smooth'
                        });
                    }
                } catch (streamError) {
                    console.error('Streaming error:', streamError);
                    throw streamError;
                }
            }

            async simulateStreaming(answerDiv) {
                // Get enhanced response from our Context7-integrated system
                const latestMessage = this.messages[this.messages.length - 1];
                const response = await this.getEnhancedResponse(latestMessage.content);

                // Simulate streaming with typewriter effect
                let currentIndex = 0;
                const streamingSpeed = 8; // ms between characters

                return new Promise((resolve) => {
                    let scrollCounter = 0;
                    const typeInterval = setInterval(() => {
                        if (currentIndex < response.text.length) {
                            answerDiv.textContent += response.text.charAt(currentIndex);
                            currentIndex++;
                            scrollCounter++;

                            // Keep bottom in view while streaming (every 5 characters for smoother performance)
                            if (scrollCounter % 5 === 0) {
                                window.scrollTo({
                                    top: document.documentElement.scrollHeight,
                                    behavior: 'auto'
                                });
                            }
                        } else {
                            clearInterval(typeInterval);

                            // Add suggestion chips
                            if (response.suggestions) {
                                this.addSuggestionChips(answerDiv, response.suggestions);
                            }


                            resolve();
                        }
                    }, streamingSpeed);
                });
            }

            async getEnhancedResponse(query) {
                // Popular Science style responses
                const responses = {
                    'ai': {
                        text: `Researchers at leading AI laboratories have developed transformer models that demonstrate unprecedented capabilities in reasoning, creativity, and problem-solving, fundamentally revolutionizing how humans interact with artificial intelligence. Recent studies show these large language models can process and generate text with remarkable sophistication, while new multimodal systems simultaneously handle text, images, and audio data with increasing accuracy. However, scientists are now grappling with important questions about AI safety, bias, and societal impact as these systems become more powerful and widespread in everyday applications.`,
                        suggestions: ['What are the latest AI breakthroughs?', 'How does AI bias work?', 'Tell me about AI safety']
                    },
                    'chatbot': {
                        text: `Computational linguists and behavioral scientists have transformed simple rule-based chatbots into sophisticated AI-powered conversational agents that use advanced natural language processing to understand context and maintain coherent dialogue. According to recent psychological research, companies are now employing techniques from behavioral science—including variable reward schedules and social validation mechanisms—to keep users engaged, representing a fundamental shift from utility-focused tools to engagement-optimized experiences. This evolution raises critical questions about digital wellness and AI dependency, as studies suggest users may develop parasocial relationships with increasingly sophisticated chatbot systems that closely mimic human conversation patterns.`,
                        suggestions: ['How do chatbots manipulate users?', 'What are the risks of AI dependency?', 'How can I protect myself?']
                    },
                    'technology': {
                        text: `Scientists and engineers across the globe are pushing the boundaries of technological innovation at an unprecedented pace, with breakthroughs in quantum computing, biotechnology, and artificial intelligence reshaping entire industries. Research teams have developed cloud computing infrastructures that enable massive scalability and remote collaboration, while Internet of Things (IoT) devices create interconnected networks where everyday objects can communicate and share data in real-time. As our digital footprint expands exponentially, cybersecurity researchers are working to develop new protection methods and regulatory frameworks to safeguard user privacy while maintaining the momentum of technological advancement.`,
                        suggestions: ['What are emerging tech trends?', 'How does quantum computing work?', 'Tell me about tech privacy']
                    }
                };

                const lowerQuery = query.toLowerCase();

                if (lowerQuery.includes('ai') || lowerQuery.includes('artificial intelligence')) {
                    return responses.ai;
                } else if (lowerQuery.includes('chatbot') || lowerQuery.includes('chat') || lowerQuery.includes('bot')) {
                    return responses.chatbot;
                } else if (lowerQuery.includes('technology') || lowerQuery.includes('tech')) {
                    return responses.technology;
                }

                // Default response in Popular Science style
                return {
                    text: `Research teams across multiple disciplines are uncovering fascinating connections between technology, society, and human behavior that continue to shape our understanding of modern life. Scientists are employing interdisciplinary approaches to analyze both immediate effects and long-term societal trends, revealing complex patterns that require careful examination from multiple perspectives. These investigations are providing crucial insights into how technological innovation, cultural shifts, and policy decisions interact in ways that fundamentally influence human development and social structures.`,
                    suggestions: ['Can you elaborate on that?', 'What are the implications?', 'Tell me more']
                };
            }

            addSuggestionChips(container, suggestions) {
                const chipsContainer = document.createElement('div');
                chipsContainer.className = 'suggestion-chips';

                suggestions.forEach(suggestion => {
                    const chip = document.createElement('span');
                    chip.className = 'suggestion-chip';
                    chip.textContent = suggestion;
                    chip.addEventListener('click', () => {
                        this.followUpInput.value = suggestion;
                        this.handleSend();
                    });
                    chipsContainer.appendChild(chip);
                });

                container.appendChild(chipsContainer);
            }

            async showLoadingStages() {
                const stages = [
                    { text: 'Generating answer...', duration: 1500 },
                    { text: 'Getting sources...', duration: 1800, showSkeleton: true },
                    { text: 'Getting attributions...', duration: 1200, hideSkeleton: true }
                ];

                // Create loading stage container
                const loadingContainer = document.createElement('div');
                loadingContainer.className = 'loading-stage-container';
                loadingContainer.id = 'loadingStages';

                // Create single stage element that will be reused
                const stageDiv = document.createElement('div');
                stageDiv.className = 'loading-stage';

                const spinnerDiv = document.createElement('div');
                spinnerDiv.className = 'spinner-icon';

                const textDiv = document.createElement('div');
                textDiv.className = 'stage-text';

                stageDiv.appendChild(spinnerDiv);
                stageDiv.appendChild(textDiv);
                loadingContainer.appendChild(stageDiv);

                this.conversationContainer.appendChild(loadingContainer);

                // Animate through stages
                for (let i = 0; i < stages.length; i++) {
                    const stage = stages[i];

                    // Update text
                    textDiv.textContent = stage.text;

                    // Fade in
                    stageDiv.classList.add('visible');

                    // Show skeleton sources during "Getting sources" stage
                    if (stage.showSkeleton) {
                        setTimeout(() => {
                            this.showSkeletonSources();
                        }, 500);
                    }

                    // Hide skeleton sources during "Getting attributions" stage
                    if (stage.hideSkeleton) {
                        const skeletonSources = document.getElementById('skeletonSources');
                        if (skeletonSources) {
                            skeletonSources.style.opacity = '0';
                            setTimeout(() => {
                                skeletonSources.remove();
                            }, 300);
                        }
                    }

                    // Wait for stage duration
                    await new Promise(resolve => setTimeout(resolve, stage.duration));

                    // Fade out (except for last stage)
                    if (i < stages.length - 1) {
                        stageDiv.classList.remove('visible');
                        await new Promise(resolve => setTimeout(resolve, 400)); // Wait for fade out
                    }
                }

                // Remove loading stages after completion
                setTimeout(() => {
                    loadingContainer.remove();
                }, 500);
            }

            async showSkeletonSources() {
                // Create skeleton sources if they don't exist
                let skeletonSources = document.getElementById('skeletonSources');
                if (!skeletonSources) {
                    skeletonSources = document.createElement('div');
                    skeletonSources.id = 'skeletonSources';
                    skeletonSources.className = 'skeleton-sources';

                    // Create 4 skeleton cards
                    for (let i = 0; i < 4; i++) {
                        const skeletonCard = document.createElement('div');
                        skeletonCard.className = 'skeleton-source-card';
                        skeletonCard.innerHTML = `
                            <div class="skeleton-header">
                                <div class="skeleton-favicon"></div>
                                <div class="skeleton-domain"></div>
                            </div>
                            <div class="skeleton-title"></div>
                            <div class="skeleton-snippet"></div>
                            <div class="skeleton-snippet"></div>
                            <div class="skeleton-attribution"></div>
                        `;
                        skeletonSources.appendChild(skeletonCard);
                    }

                    // Insert after user message but before AI response
                    this.conversationContainer.appendChild(skeletonSources);
                }

                skeletonSources.style.display = 'grid';
                skeletonSources.style.opacity = '0';

                setTimeout(() => {
                    skeletonSources.style.transition = 'opacity 0.3s ease';
                    skeletonSources.style.opacity = '1';
                }, 100);
            }

            async showAttributionAndSources() {
                // Remove skeleton sources completely
                const skeletonSources = document.getElementById('skeletonSources');
                if (skeletonSources) {
                    skeletonSources.style.opacity = '0';
                    setTimeout(() => {
                        skeletonSources.remove();
                    }, 300);
                }

                // Create attribution section
                const attributionSection = document.createElement('div');
                attributionSection.className = 'attribution-section';
                attributionSection.id = 'attributionSection';
                attributionSection.innerHTML = `
                    <div class="attribution-title">Source Attribution</div>
                    <div class="combined-attribution-bar">
                        <div class="attribution-segment primary" data-width="38"></div>
                        <div class="attribution-segment secondary" data-width="38"></div>
                        <div class="attribution-segment tertiary" data-width="24"></div>
                    </div>
                    <div class="attribution-labels">
                        <div class="attribution-label primary">38% Popular Science</div>
                        <div class="attribution-label secondary">38% Scientific American</div>
                        <div class="attribution-label tertiary">24% Other</div>
                    </div>
                `;

                // Create sources section
                const sourcesSection = document.createElement('div');
                sourcesSection.className = 'sources-section';
                sourcesSection.id = 'sourcesSection';
                sourcesSection.innerHTML = `
                    <div class="sources-title">Sources</div>
                    <div class="sources-carousel-wrapper">
                        <button class="carousel-button" id="prevButton">‹</button>
                        <div class="sources-carousel-container">
                            <div class="sources-carousel" id="sourcesCarousel">
                            <div class="source-card">
                                <div class="source-header">
                                    <div class="source-favicon">PS</div>
                                    <div class="source-domain">Popular Science</div>
                                </div>
                                <div class="source-title">The Evolution of Human Intelligence</div>
                                <div class="source-snippet">Recent studies show brain development accelerated through evolutionary pressure...</div>
                                <div class="source-attribution">38% attribution</div>
                            </div>
                            <div class="source-card">
                                <div class="source-header">
                                    <div class="source-favicon">SA</div>
                                    <div class="source-domain">Scientific American</div>
                                </div>
                                <div class="source-title">Cognitive Development in Early Ancestors</div>
                                <div class="source-snippet">Archaeological evidence suggests tool use drove brain evolution...</div>
                                <div class="source-attribution">38% attribution</div>
                            </div>
                            <div class="source-card">
                                <div class="source-header">
                                    <div class="source-favicon">NE</div>
                                    <div class="source-domain">Nature</div>
                                </div>
                                <div class="source-title">Neurological Studies on Brain Expansion</div>
                                <div class="source-snippet">Comparative analysis reveals key differences between human and primate structures...</div>
                                <div class="source-attribution">24% attribution</div>
                            </div>
                            <div class="source-card">
                                <div class="source-header">
                                    <div class="source-favicon">SC</div>
                                    <div class="source-domain">Science</div>
                                </div>
                                <div class="source-title">Neural Pathways in Human Evolution</div>
                                <div class="source-snippet">Research shows how neural complexity increased over time...</div>
                                <div class="source-attribution">18% attribution</div>
                            </div>
                            </div>
                        </div>
                        <button class="carousel-button" id="nextButton">›</button>
                    </div>
                    <div class="carousel-nav">
                        <div class="carousel-indicators">
                            <div class="carousel-dot active" data-card="0"></div>
                            <div class="carousel-dot" data-card="1"></div>
                            <div class="carousel-dot" data-card="2"></div>
                            <div class="carousel-dot" data-card="3"></div>
                        </div>
                    </div>
                `;

                // Insert attribution and sources after user question but before AI response
                this.conversationContainer.appendChild(attributionSection);
                this.conversationContainer.appendChild(sourcesSection);

                // Animate attribution section
                attributionSection.style.opacity = '0';
                setTimeout(() => {
                    attributionSection.style.transition = 'opacity 0.5s ease';
                    attributionSection.style.opacity = '1';
                }, 100);

                // Animate attribution bar segments
                setTimeout(() => {
                    const segments = attributionSection.querySelectorAll('.attribution-segment');
                    segments.forEach((segment, index) => {
                        setTimeout(() => {
                            const targetWidth = segment.getAttribute('data-width');
                            segment.style.width = targetWidth + '%';
                        }, index * 200);
                    });
                }, 500);

                // Show sources section
                setTimeout(() => {
                    sourcesSection.style.opacity = '0';
                    sourcesSection.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        sourcesSection.style.opacity = '1';
                        // Initialize carousel after sources are visible
                        this.initializeCarousel();
                    }, 100);
                }, 800);
            }

            initializeCarousel() {
                const carousel = document.getElementById('sourcesCarousel');
                const prevButton = document.getElementById('prevButton');
                const nextButton = document.getElementById('nextButton');
                const dots = document.querySelectorAll('.carousel-dot');

                let currentIndex = 0;
                const cardsPerView = 3; // Show 3 cards at a time

                // Initial setup
                updateCarousel();

                // Add click handlers for arrows
                if (prevButton) {
                    prevButton.addEventListener('click', () => {
                        if (currentIndex > 0) {
                            currentIndex--;
                            updateCarousel();
                        }
                    });
                }

                if (nextButton) {
                    nextButton.addEventListener('click', () => {
                        if (currentIndex < Math.max(0, dots.length - cardsPerView)) {
                            currentIndex++;
                            updateCarousel();
                        }
                    });
                }

                // Add click handlers for dots
                dots.forEach((dot, index) => {
                    dot.addEventListener('click', () => {
                        currentIndex = Math.min(index, Math.max(0, dots.length - cardsPerView));
                        updateCarousel();
                    });
                });

                function updateCarousel() {
                    // Calculate the transform distance
                    const cardWidth = 216; // 200px width + 16px gap
                    const translateX = -currentIndex * cardWidth;

                    // Apply transform to carousel
                    if (carousel) {
                        carousel.style.transform = `translateX(${translateX}px)`;
                    }

                    // Update dots - highlight the visible range
                    dots.forEach((dot, index) => {
                        const isVisible = index >= currentIndex && index < currentIndex + cardsPerView;
                        dot.classList.toggle('active', index === currentIndex);
                    });

                    // Update button states
                    if (prevButton) {
                        prevButton.disabled = currentIndex === 0;
                        prevButton.style.background = currentIndex === 0 ? '#bdc3c7' : '#e74c3c';
                    }

                    if (nextButton) {
                        const maxIndex = Math.max(0, dots.length - cardsPerView);
                        nextButton.disabled = currentIndex >= maxIndex;
                        nextButton.style.background = currentIndex >= maxIndex ? '#bdc3c7' : '#e74c3c';
                    }
                }
            }


            async initializeWithQuery(query) {
                document.title = `"${query}" - AI Search Results - The Atlantic`;

                // Add initial user message
                this.addMessage(query, 'user');
                this.messages.push({ role: 'user', content: query });

                // Start streaming response
                await this.streamAIResponse();
            }
        }

        // Initialize the chat system
        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Navigation dropdown functionality
            const navDropdown = document.getElementById('navDropdown');
            const navDropdownButton = document.getElementById('navDropdownButton');
            const navDropdownMenu = document.getElementById('navDropdownMenu');

            if (navDropdownButton && navDropdownMenu) {
                navDropdownButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navDropdownMenu.style.display = navDropdownMenu.style.display === 'block' ? 'none' : 'block';
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    navDropdownMenu.style.display = 'none';
                });
            }

            // Initialize chat
            const chat = new AIChat();
            const query = getQueryParameter('q');

            if (query) {
                chat.initializeWithQuery(query);
            } else {
                document.getElementById('conversationContainer').innerHTML =
                    '<div class="error-message">Please enter a search query to get started.</div>';
            }
        });
    </script>
</body>
</html>